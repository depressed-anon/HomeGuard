version: '3'

services:
  # Unbound - Recursive DNS resolver for privacy
  unbound:
    image: docker.io/mvance/unbound:latest
    container_name: unbound
    restart: unless-stopped
    hostname: unbound
    volumes:
      - ./configs/unbound/unbound.conf:/opt/unbound/etc/unbound/unbound.conf:ro
    ports:
      - "5335:5335/tcp"
      - "5335:5335/udp"
    networks:
      - homeguard-net

  # Pi-hole - DNS with ad-blocking (Network-wide)
  pihole:
    image: docker.io/pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    hostname: homeguard
    depends_on:
      - unbound
    environment:
      TZ: 'America/New_York'
      WEBPASSWORD: '${PIHOLE_PASSWORD:-changeme123}'
      PIHOLE_DNS_: 'unbound#5335'
      DNSSEC: 'true'
      DNSMASQ_LISTENING: 'all'
      VIRTUAL_HOST: 'homeguard.local'
      ServerIP: '${SERVER_IP:-192.168.1.100}'
      INTERFACE: 'eth0'
    volumes:
      - ./data/pihole/etc-pihole:/etc/pihole
      - ./data/pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "80:80/tcp"  # Web interface - network accessible
    networks:
      - homeguard-net
    dns:
      - 127.0.0.1
      - 1.1.1.1

  # Dashboard - Enhanced web interface
  dashboard:
    image: docker.io/nginx:alpine
    container_name: homeguard-dashboard
    restart: unless-stopped
    hostname: dashboard
    volumes:
      - ./setup-wizard:/usr/share/nginx/html:ro
      - ./configs/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8080:80/tcp"
    networks:
      - homeguard-net
    depends_on:
      - pihole

  # Network Monitor - Device discovery and monitoring
  netmonitor:
    image: docker.io/python:3.11-slim
    container_name: netmonitor
    restart: unless-stopped
    hostname: netmonitor
    volumes:
      - ./scripts/netmonitor:/app:ro
      - ./data/netmonitor:/data
    working_dir: /app
    command: python3 monitor.py
    network_mode: host  # Needed for network scanning
    cap_add:
      - NET_ADMIN
      - NET_RAW

networks:
  homeguard-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
